<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAVENå†…ç½‘è¾…åŠ©å·¥å…·</title>

    <link rel="stylesheet" href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css">
</head>
<body class="p-4">
    <div class="bg-white shadow overflow-hidden sm:rounded-lg">
        <div class="px-4 py-5 sm:px-6">
            <img src="https://maven.apache.org/images/maven-logo-black-on-white.png" />
            <h3 class="text-xl leading-6 font-medium text-gray-900"></h3>
            <p class="mt-2 max-w-2xl text-sm text-gray-500"> <b class="text-blue-600">MAVEN å†…ç½‘åŠ©æ‰‹</b> æœ¬å·¥å…·å®ç°å¢é‡æ›´æ–° JAR åŒ…åˆ°å†…ç½‘ nexus3 ï¼ˆæ— äº’è”ç½‘æ¡ä»¶ï¼‰ç§æœåŠŸèƒ½</p>
        </div>
        <div class="border-t border-gray-200 p-2">
            <div>
                <label for="repository" class="block text-sm font-medium text-gray-700">MAVEN ä»“åº“ç›®å½•/ç§æœåœ°å€åŠè´¦å¯†</label>
                <div class="flex space-x-3">
                    <input id="repository" onclick="pickRepo()" class="flex-grow bg-gray-200 p-1" placeholder="è¯·é€‰æ‹© maven ä»“åº“ç›®å½•" />
                    <input id="nexus" class="flex-grow bg-gray-200 p-1" placeholder="MAVENç§æœåœ°å€" />
                    <input id="auth" class="flex-grow bg-gray-200 p-1" placeholder="ç§æœè´¦å¯†" />
                    <!-- <button class="flex-none px-2 border shadow-sm text-white bg-yellow-400" onclick="pickRepo()">é€‰æ‹©ç›®å½•</button> -->
                </div>

                <div class="flex space-x-3 pt-3 text-3xl">
                    <button class="p-7 flex-grow border shadow-sm text-white bg-blue-600" onclick="tongji()">ğŸŒ å…¥æ± ç»Ÿè®¡</button>
                    <button class="p-7 flex-grow border shadow-sm text-white bg-blue-600" onclick="bidui()">âœˆï¸ å¢é‡æ‹·è´</button>
                    <button class="p-7 flex-grow border shadow-sm text-white bg-blue-600" onclick="upload()">â˜ï¸ ä¸Šä¼ ç§æœ</button>
                </div>

                <div class="flex space-x-2 py-2">
                    <div id="console" class="text-sm text-gray-600 truncate flex-grow">è¯·é€‰æœ¬åœ° MAVEN ä»“åº“åç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹ä½œä¸š</div>
                    <svg id="loading" style="display:none;" class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>

                <div class="border-t border-gray-300">
                    <h5 class="py-1">è¯´æ˜</h5>
                    <p class="text-sm text-gray-500">â‘  å…¥æ± ç»Ÿè®¡ï¼šç»Ÿè®¡å†…ç½‘å·²å…¥åº“çš„ JAR åŒ…ï¼ˆè¿½åŠ åˆ°åˆ° maven.txtï¼‰</p>
                    <p class="text-sm text-gray-500">â‘¡ å¢é‡æ‹·è´ï¼šå°†ä»“åº“ç›®å½•ä¸­çš„æ–‡ä»¶ä¸ maven.txt æ¯”å¯¹ï¼Œæ‹·è´æ–°å¢ JAR/POM åˆ° repository ç›®å½•</p>
                    <p class="text-sm text-gray-500">â‘¢ ä¸Šä¼ ç§æœï¼šå°†ä»“åº“ç›®å½•ä¸‹çš„æ–‡ä»¶æäº¤åˆ°å†…ç½‘ç§æœ</p>
                </div>

                <div class="mt-5 text-blue-500 text-lg">
                    â„¹ï¸ å…³äº
                </div>
                <div class="border-t mt-1 border-gray-200 p-3">
                    å›¾ç‰‡
                </div>
            </div>
        </div>
      </div>
</body>

<script>
    /**
     * åŸºäº WebWorker çš„å®ç°æ–¹æ¡ˆ
     * ä¸æ»‘ä½“éªŒ
     */
    const outTxt    = __dirname+"/maven.txt"
    let working     = false
    let repoDir     = ""

    let pickRepo = (id='repository')=>{
        API("select-directory").then(f=>QV(`#${id}`, f))
    }

    let changeWorking = v=>{
        working = v
        Q("#loading").style.display = v===true?"":"none"
    }

    let _checkAndStart = (method, ps)=>{
        if(working)     return alert("è¯·ç­‰å¾…å½“å‰ä½œä¸šå®Œæˆ")

        repoDir = QV("#repository")
        if(!repoDir)    return alert("è¯·å…ˆé€‰æ‹©ä»“åº“ç›®å½•")

        changeWorking(true)

        let worker = new Worker("./webworker.js")
        worker.postMessage(Object.assign({ outTxt }, ps, { repoDir, method }))
        worker.onmessage = e=>{
            let { msg, count } = e.data
            if(count === true){
                changeWorking(false)
                worker.terminate()
                worker = undefined
            }

            Q("#console").innerText=`${count != true?("("+count+")"):""}${msg}`
        }
    }

    let tongji = ()=> _checkAndStart("fillUp", {clean: false})

    let bidui = ()=>_checkAndStart("increment", {targetDir: __dirname+"/repository"})

    let upload = ()=>{
        let host = QV("#nexus")
        let auth = QV("#auth")

        let errorMsg = ""
        if(!host || host.indexOf("http"))   errorMsg = "ç§æœåœ°å€ä¸èƒ½ä¸ºç©ºä¸”å¿…é¡»ä»¥ http å¼€å¤´"
        else if(!auth)                      errorMsg = "ç§æœè´¦å¯†ä¸èƒ½ä¸ºç©º"
        if(errorMsg){
            return alert(errorMsg)
        }

        _checkAndStart("upload", {host, auth})
    }
</script>

<!-- <script>
    const M = require("./maven.js")
    const outTxt = __dirname+"/maven.txt"

    let working = false
    let repoDir = ""

    let changeWorking = v=>{
        working = v
        Q("#loading").style.display = v===true?"":"none"
    }

    let _checkAndStart = worker=>{
        if(working) return alert("è¯·ç­‰å¾…å½“å‰ä½œä¸šå®Œæˆ")
        repoDir = QV("#repository")
        if(!repoDir)    return alert("è¯·å…ˆé€‰æ‹©ä»“åº“ç›®å½•")

        changeWorking(true)
        worker()        //new Worker("./webworker.js")
    }

    let pickRepo = (id='repository')=>{
        API("select-directory").then(f=>QV(`#${id}`, f))
    }

    let logger = (msg, count)=>{
        if(count === true)  changeWorking(false)
        requestAnimationFrame(()=>Q("#console").innerText=`${count != true?("("+count+")"):""}${msg}`)
    }

    let tongji = ()=>_checkAndStart(()=> M.fillUp(repoDir, outTxt, false, logger))

    let bidui = ()=>_checkAndStart(()=> M.increment(repoDir, outTxt, __dirname+"/repository", logger))

    let upload = ()=>_checkAndStart(()=>{
        let url = QV("#nexus")
        let auth = QV("#auth")

        let errorMsg = ""
        if(!url || url.indexOf("http"))     errorMsg = "ç§æœåœ°å€ä¸èƒ½ä¸ºç©ºä¸”å¿…é¡»ä»¥ http å¼€å¤´"
        else if(!auth)                      errorMsg = "ç§æœè´¦å¯†ä¸èƒ½ä¸ºç©º"
        if(errorMsg){
            changeWorking(false)
            return alert(errorMsg)
        }

        M.upload(repoDir, url, auth, logger)
    })
</script> -->
</html>
